<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wound Vac Tracker (PHIâ€‘Free)</title>
  <meta name="description" content="PHIâ€‘free wound vac tracker: barcode scan, location, status, audit trail." />
  <style>
    :root { --pad: 14px; --radius: 12px; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 0; background: #f6f7f9; color: #111; }
    header { position: sticky; top: 0; background: white; border-bottom: 1px solid #e6e8ee; padding: var(--pad); z-index: 5; }
    header h1 { font-size: 18px; margin: 0 0 6px 0; }
    header .sub { font-size: 12px; color: #555; display:flex; gap:10px; flex-wrap:wrap; }
    main { padding: var(--pad); max-width: 980px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .card { background: white; border: 1px solid #e6e8ee; border-radius: var(--radius); padding: var(--pad); box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .kpi { display:flex; flex-direction:column; gap:4px; }
    .kpi .num { font-size: 26px; font-weight: 700; }
    .kpi .label { font-size: 12px; color:#666; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button, textarea { font: inherit; padding: 10px 12px; border-radius: 10px; border:1px solid #cfd6e4; background:white; }
    input[type="search"]{ flex: 1; min-width: 220px; }
    button { cursor:pointer; border: 1px solid #1e2a44; background:#1e2a44; color:white; }
    button.secondary { background: white; color:#1e2a44; }
    button.danger { background: #b42318; border-color:#b42318; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; border-bottom: 1px solid #eef1f6; padding: 10px 8px; font-size: 13px; vertical-align: top; }
    th { font-size: 12px; color:#555; text-transform: uppercase; letter-spacing:.02em; }
    .pill { display:inline-block; padding: 3px 10px; border-radius: 999px; font-size: 12px; border:1px solid #e6e8ee; background:#fafbff;}
    .muted { color:#666; font-size: 12px; }
    .right { text-align:right; }
    .nowrap { white-space:nowrap; }
    .modal-backdrop { position:fixed; inset:0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 10;}
    .modal { width: min(720px, 100%); background:white; border-radius: 14px; border: 1px solid #e6e8ee; overflow:hidden; }
    .modal header { position:unset; border-bottom: 1px solid #eef1f6; }
    .modal main { padding: var(--pad); }
    .modal footer { display:flex; gap:10px; justify-content:flex-end; padding: var(--pad); border-top:1px solid #eef1f6; background:#fafbff; }
    .two { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .three { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    label { display:block; font-size: 12px; color:#555; margin: 4px 0 6px; }
    .small { font-size: 12px; }
    .scanner { display:none; }
    video { width:100%; border-radius: 12px; background:#000; }
    @media (max-width: 700px){
      .two, .three { grid-template-columns: 1fr; }
      th:nth-child(4), td:nth-child(4) { display:none; } /* hide Updated By on small screens */
    }
  </style>
</head>
<body>
<header>
  <h1>Wound Vac Tracker <span class="pill">PHIâ€‘Free</span></h1>
  <div class="sub">
    <span>âœ… No patient name / MRN</span>
    <span>ðŸ“· Camera barcode scan</span>
    <span>ðŸ’¾ Saves on this device (localStorage)</span>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card" style="grid-column: span 3;">
      <div class="kpi"><div class="num" id="kpiTotal">0</div><div class="label">Total devices</div></div>
    </div>
    <div class="card" style="grid-column: span 3;">
      <div class="kpi"><div class="num" id="kpiAvailable">0</div><div class="label">Available (In Stock)</div></div>
    </div>
    <div class="card" style="grid-column: span 3;">
      <div class="kpi"><div class="num" id="kpiInUse">0</div><div class="label">In Use (Assigned)</div></div>
    </div>
    <div class="card" style="grid-column: span 3;">
      <div class="kpi"><div class="num" id="kpiMissing">0</div><div class="label">Missing / Overdue</div></div>
    </div>

    <div class="card" style="grid-column: span 12;">
      <div class="row">
        <input id="search" type="search" placeholder="Search by Device ID / Unit / Room / Bed / Statusâ€¦" />
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option>In Stock</option>
          <option>Assigned</option>
          <option>Cleaning</option>
          <option>Maintenance</option>
          <option>Missing</option>
        </select>
        <button id="btnAdd">+ Add / Scan</button>
        <button class="secondary" id="btnExport">Export CSV</button>
        <button class="secondary" id="btnImport">Import</button>
        <button class="secondary" id="btnReset">Reset</button>
      </div>
      <p class="muted" style="margin-top:10px;">
        Tip: Add this page to your iPhone Home Screen (Share â†’ Add to Home Screen) so it behaves like an app.
      </p>

      <div style="overflow:auto; margin-top: 8px;">
        <table>
          <thead>
            <tr>
              <th>Device ID</th>
              <th>Status</th>
              <th>Location (Unit / Room / Bed)</th>
              <th>Updated By</th>
              <th class="nowrap">Last Update</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <p class="muted small" id="emptyState" style="display:none; margin-top:12px;">
        No devices yet. Tap <b>+ Add / Scan</b> to add your first wound vac.
      </p>
    </div>
  </div>
</main>

<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <h1 id="modalTitle" style="font-size:16px; margin:0;">Add / Update Device</h1>
      <div class="sub"><span class="muted">PHIâ€‘free: do not enter patient names or MRNs.</span></div>
    </header>
    <main>
      <div class="two">
        <div>
          <label for="deviceId">Device ID / Barcode</label>
          <input id="deviceId" placeholder="Scan or type device barcode" />
        </div>
        <div>
          <label for="status">Status</label>
          <select id="status">
            <option>In Stock</option>
            <option>Assigned</option>
            <option>Cleaning</option>
            <option>Maintenance</option>
            <option>Missing</option>
          </select>
        </div>
      </div>

      <div class="three" style="margin-top:10px;">
        <div>
          <label for="unit">Unit</label>
          <input id="unit" placeholder="e.g., 3W / ICU / ED" />
        </div>
        <div>
          <label for="room">Room</label>
          <input id="room" placeholder="e.g., 312" />
        </div>
        <div>
          <label for="bed">Bed</label>
          <input id="bed" placeholder="e.g., A" />
        </div>
      </div>

      <div class="two" style="margin-top:10px;">
        <div>
          <label for="updatedBy">Updated by (optional)</label>
          <input id="updatedBy" placeholder="e.g., CS Tech / RN initials" />
        </div>
        <div>
          <label for="notes">Notes (optional, PHIâ€‘free)</label>
          <input id="notes" placeholder="e.g., needs canister, battery low" />
        </div>
      </div>

      <div class="card scanner" id="scannerCard" style="margin-top:12px;">
        <div class="row" style="justify-content:space-between;">
          <div><b>Barcode scanner</b> <span class="muted small">Point camera at barcode</span></div>
          <button class="secondary" id="btnStopScan" type="button">Stop</button>
        </div>
        <div style="margin-top:10px;">
          <div id="qr-reader"></div>
          <p class="muted small" id="scanHint" style="margin:10px 0 0;">If scanning fails, type Device ID manually.</p>
        </div>
      </div>
    </main>
    <footer>
      <button class="secondary" id="btnScan" type="button">ðŸ“· Scan barcode</button>
      <button class="secondary" id="btnCancel" type="button">Cancel</button>
      <button id="btnSave" type="button">Save</button>
    </footer>
  </div>
</div>

<input id="filePicker" type="file" accept=".json" style="display:none;" />

<!-- html5-qrcode (camera barcode/QR scanning). Works on iOS Safari when hosted on HTTPS. -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
  // -------------------------
  // Data model (PHI-free)
  // -------------------------
  const STORAGE_KEY = "woundvac_tracker_v1";
  /** @type {{devices: Array<any>, audit: Array<any>}} */
  let state = loadState();

  let editingId = null;

  const el = (id) => document.getElementById(id);

  function nowIso() { return new Date().toISOString(); }
  function fmt(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString();
    } catch(e){ return ts || ""; }
  }

  function loadState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { devices: [], audit: [] };
    try { return JSON.parse(raw); } catch(e) { return { devices: [], audit: [] }; }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function addAudit(action, device){
    state.audit.unshift({
      ts: nowIso(),
      action,
      deviceId: device.deviceId,
      status: device.status,
      location: `${device.unit||""}/${device.room||""}/${device.bed||""}`.replace(/\/+$/,""),
      updatedBy: device.updatedBy || ""
    });
    // keep last 500
    state.audit = state.audit.slice(0, 500);
  }

  function upsertDevice(device){
    const idx = state.devices.findIndex(d => d.id === device.id);
    if(idx >= 0){
      state.devices[idx] = device;
      addAudit("UPDATE", device);
    } else {
      state.devices.unshift(device);
      addAudit("ADD", device);
    }
    saveState();
    render();
  }

  function deleteDevice(id){
    const idx = state.devices.findIndex(d => d.id === id);
    if(idx >= 0){
      const removed = state.devices[idx];
      state.devices.splice(idx, 1);
      addAudit("DELETE", removed);
      saveState();
      render();
    }
  }

  // -------------------------
  // UI Rendering
  // -------------------------
  function matchesFilters(d){
    const q = el("search").value.trim().toLowerCase();
    const sf = el("statusFilter").value;
    if(sf && d.status !== sf) return false;
    if(!q) return true;
    const hay = [
      d.deviceId, d.status, d.unit, d.room, d.bed, d.updatedBy, d.notes
    ].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }

  function renderKPIs(){
    const devices = state.devices;
    const total = devices.length;
    const available = devices.filter(d => d.status === "In Stock").length;
    const inUse = devices.filter(d => d.status === "Assigned").length;
    const missing = devices.filter(d => d.status === "Missing").length;
    el("kpiTotal").textContent = total;
    el("kpiAvailable").textContent = available;
    el("kpiInUse").textContent = inUse;
    el("kpiMissing").textContent = missing;
  }

  function renderTable(){
    const rows = el("rows");
    rows.innerHTML = "";
    const filtered = state.devices.filter(matchesFilters);
    el("emptyState").style.display = (state.devices.length === 0) ? "block" : "none";

    for(const d of filtered){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><b>${escapeHtml(d.deviceId || "")}</b><div class="muted small">${escapeHtml(d.notes || "")}</div></td>
        <td><span class="pill">${escapeHtml(d.status || "")}</span></td>
        <td>
          <div class="nowrap">${escapeHtml(d.unit || "")} ${d.unit? "Â·": ""} ${escapeHtml(d.room || "")} ${d.room? "Â·": ""} ${escapeHtml(d.bed || "")}</div>
        </td>
        <td>${escapeHtml(d.updatedBy || "")}</td>
        <td class="nowrap">${escapeHtml(fmt(d.updatedAt))}</td>
        <td class="right nowrap">
          <button class="secondary" data-action="edit" data-id="${d.id}">Edit</button>
          <button class="danger" data-action="delete" data-id="${d.id}">Delete</button>
        </td>
      `;
      rows.appendChild(tr);
    }
  }

  function render(){
    renderKPIs();
    renderTable();
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // -------------------------
  // Modal helpers
  // -------------------------
  function openModal(device=null){
    editingId = device?.id || null;
    el("modalTitle").textContent = editingId ? "Update Device" : "Add Device";
    el("deviceId").value = device?.deviceId || "";
    el("status").value = device?.status || "In Stock";
    el("unit").value = device?.unit || "";
    el("room").value = device?.room || "";
    el("bed").value = device?.bed || "";
    el("updatedBy").value = device?.updatedBy || "";
    el("notes").value = device?.notes || "";
    showModal(true);
  }

  function showModal(show){
    el("modalBackdrop").style.display = show ? "flex" : "none";
    el("modalBackdrop").setAttribute("aria-hidden", show ? "false" : "true");
    if(show) setTimeout(()=>el("deviceId").focus(), 0);
    if(!show) stopScanner();
  }

  // -------------------------
  // Scanner (html5-qrcode)
  // -------------------------
  let html5QrCode = null;

  async function startScanner(){
    const card = el("scannerCard");
    card.style.display = "block";
    try{
      if(!html5QrCode){
        html5QrCode = new Html5Qrcode("qr-reader");
      }
      const config = {
        fps: 10,
        qrbox: { width: 260, height: 160 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          // barcode/QR payload
          el("deviceId").value = decodedText.trim();
          stopScanner();
        },
        (err) => { /* ignore */ }
      );
      el("scanHint").textContent = "Scanningâ€¦ hold steady over the barcode.";
    } catch(e){
      el("scanHint").textContent = "Camera scan failed (often due to nonâ€‘HTTPS hosting). Type Device ID manually.";
    }
  }

  async function stopScanner(){
    const card = el("scannerCard");
    card.style.display = "none";
    if(html5QrCode){
      try { await html5QrCode.stop(); } catch(e) { /* ignore */ }
      try { await html5QrCode.clear(); } catch(e) { /* ignore */ }
      html5QrCode = null;
      // recreate container content to avoid iOS camera locks
      document.getElementById("qr-reader").innerHTML = "";
    }
  }

  // -------------------------
  // Import/Export
  // -------------------------
  function exportCSV(){
    const cols = ["deviceId","status","unit","room","bed","updatedBy","notes","updatedAt"];
    const lines = [cols.join(",")];
    for(const d of state.devices){
      const row = cols.map(c => csvEscape(d[c] ?? ""));
      lines.push(row.join(","));
    }
    const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `woundvac_devices_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }
  function csvEscape(v){
    const s = String(v).replaceAll('"','""');
    return `"${s}"`;
  }

  function exportJSON(){
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `woundvac_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  function importJSONFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(!data || !Array.isArray(data.devices)) throw new Error("Invalid file");
        state = {
          devices: data.devices.map(d => ({...d, id: d.id || crypto.randomUUID()})),
          audit: Array.isArray(data.audit) ? data.audit : []
        };
        saveState();
        render();
        alert("Import complete.");
      } catch(e){
        alert("Import failed. Please select a valid backup JSON.");
      }
    };
    reader.readAsText(file);
  }

  // -------------------------
  // Events
  // -------------------------
  el("btnAdd").addEventListener("click", ()=>openModal(null));
  el("btnCancel").addEventListener("click", ()=>showModal(false));
  el("modalBackdrop").addEventListener("click", (e)=>{ if(e.target === el("modalBackdrop")) showModal(false); });
  el("search").addEventListener("input", render);
  el("statusFilter").addEventListener("change", render);

  el("rows").addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    if(action === "edit"){
      const device = state.devices.find(d => d.id === id);
      if(device) openModal(device);
    } else if(action === "delete"){
      if(confirm("Delete this device?")){
        deleteDevice(id);
      }
    }
  });

  el("btnSave").addEventListener("click", ()=>{
    const deviceId = el("deviceId").value.trim();
    if(!deviceId){
      alert("Device ID is required.");
      el("deviceId").focus();
      return;
    }
    const device = {
      id: editingId || crypto.randomUUID(),
      deviceId,
      status: el("status").value,
      unit: el("unit").value.trim(),
      room: el("room").value.trim(),
      bed: el("bed").value.trim(),
      updatedBy: el("updatedBy").value.trim(),
      notes: el("notes").value.trim(),
      updatedAt: nowIso()
    };
    upsertDevice(device);
    showModal(false);
  });

  el("btnScan").addEventListener("click", startScanner);
  el("btnStopScan").addEventListener("click", stopScanner);

  el("btnExport").addEventListener("click", ()=>{
    const choice = prompt("Type 1 for CSV export, 2 for JSON backup:", "1");
    if(choice === "2") exportJSON(); else exportCSV();
  });

  el("btnImport").addEventListener("click", ()=>{
    el("filePicker").value = "";
    el("filePicker").click();
  });

  el("filePicker").addEventListener("change", (e)=>{
    const file = e.target.files?.[0];
    if(file) importJSONFile(file);
  });

  el("btnReset").addEventListener("click", ()=>{
    if(confirm("Reset will delete all devices stored on THIS device/browser. Continue?")){
      localStorage.removeItem(STORAGE_KEY);
      state = { devices: [], audit: [] };
      render();
    }
  });

  // Seed hint if empty
  if(state.devices.length === 0){
    // Keep empty. (No sample data to avoid confusion at work.)
  }
  render();
</script>
</body>
</html>
